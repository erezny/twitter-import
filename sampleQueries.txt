

Get all records in need of an update

``
{$or: [{'state.query_followers': true},{'state.query_friends': true},{'state.expand_followers': {$gt: 0}},{'state.expand_friends': {$gt: 0}}] }
{id_str: 1, screen_name: 1, name:1, internal: 1, followers_count: 1, state: 1, friends_count: 1, friends: 1, followers: 1}
{followers_count: 1}
``

Find people followed by many people you follow

{replace: 'socialStats'}
{ 'internal.query_followers': 1, 'state.query_followers':0 }

function() {
this.friends.forEach(function (user){
  emit(user, 1);
})
}

function(key, values) {
  return Array.sum(values);
}



'state.expand_friends': {$gt: 0},'locks.expand_friends': 0,'locks.query_user': 0,  'state.query_friends': 0,friends_count: {$gt : 0}}

{'state.query_friends': 1,'locks.query_friends': 0,'locks.query_user': 0,friends_count: {$gt : 0}}
{ 'state.expand_friends': -1, friends_count: 1}

> db.socialGraph.ensureIndex({'state.query_followers': -1,'locks.query_followers': 1,'locks.query_user': 1, 'state.expand_followers': -1, 'internal.expand_followers': -1, followers_count: -1}, {name: "query_followers on deck index", background: true})
> db.socialGraph.ensureIndex({'state.query_friends': -1,'locks.query_friends': 1,'locks.query_user': 1, 'state.expand_friends': -1, 'internal.expand_friends': -1, friends_count: -1}, {name: "query_friends on deck index", background: true})
> db.socialGraph.ensureIndex({'state.expand_friends': -1,'locks.expand_friends': 1,'locks.query_user': 1, 'state.query_friends': 1,'internal.expand_friends': -1,  friends_count: -1}, {name: "expand_friends on deck index", background: true})
> db.socialGraph.ensureIndex({'state.expand_followers': -1,'locks.expand_followers': 1,'locks.query_user': 1, 'state.query_followers': 1, 'internal.expand_followers': -1, followers_count: -1}, {name: "expand_followers on deck index", background: true})

> db.socialGraph.ensureIndex({'state.query_followers': -1,'state.query_friends': -1, 'state.expand_followers': -1,'state.expand_friends': -1}, {name: "total left to query index"})


{replace: 'socialStats'}
function(){
  emit ('state.query_friends', this.state.query_friends);
  emit ('state.query_followers', this.state.query_followers);
  emit ('state.expand_friends', this.state.expand_friends);
  emit ('state.expand_followers', this.state.expand_followers);
  emit ('internal.query_friends', this.internal.query_friends);
  emit ('internal.query_followers', this.internal.query_followers);
  emit ('internal.expand_friends-' + this.internal.expand_friends, 1);
  emit ('internal.expand_followers-'+this.state.expand_followers ,1);
if (this.internal.query_friends && ! this.state.query_friends){
  emit ('finished.query_friends', 1);
}
if (this.internal.query_followers && ! this.state.query_followers){
  emit ('finished.query_followers', 1);
}
if (this.internal.expand_friends && ! this.state.expand_friends){
  emit ('finished.expand_friends', 1);
}
if (this.internal.expand_followers && ! this.state.expand_followers){
  emit ('finished.expand_followers', 1);
}
}
function(key, values) {
  return Array.sum(values);
}
